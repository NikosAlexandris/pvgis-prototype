image: python:3.11

pages:
  tags:
    - "shared-docker"
  stage: deploy  # Add explicit stage
  artifacts:
    paths:
      - public
      - build.log
    when: always
    expire_in: 1 week
  rules:
    # Trigger on documentation branch
    - if: $CI_COMMIT_REF_NAME == 'documentation-pre-build-public'
  script:
    - echo "Publish the pre-built documentation found in the 'public' directory"
    # Verify public directory exists
    - |
      if [ ! -d "public" ]; then
        echo "❌ ERROR: public directory does not exist!"
        echo "Available directories:"
        ls -la
        exit 1
      fi
    # List contents for debugging
    - echo "Contents of public directory:"
    - ls -la public/
    # Conditionally generate sitemap.xml.gz if sitemap.xml exists
    - |
      if [ -f "public/sitemap.xml" ]; then
        echo "✅ Generating sitemap.xml.gz inside public/"
        gzip -k public/sitemap.xml
        echo "✅ sitemap.xml.gz created"
      else
        echo "⚠️  sitemap.xml not found; skipping sitemap.xml.gz generation"
      fi
    # Verify public directory is not empty
    - |
      if [ -z "$(ls -A public)" ]; then
        echo "❌ ERROR: public directory is empty!"
        exit 1
      fi
    - echo "✅ Pages deployment ready"